# .github/workflows/daily-stock-check.yml
# Workflow para execuÃ§Ã£o automÃ¡tica diÃ¡ria do sistema de verificaÃ§Ã£o de estoque

name: ğŸ¤– Daily Stock Check - Sistema Magento

on:
  schedule:
    - cron: '0 9 * * *'  # Executa todo dia Ã s 09:00 UTC (06:00 BRT)
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Modo de teste (apenas poucos produtos)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      batch_size:
        description: 'Tamanho do batch'
        required: false
        default: '50'

jobs:
  stock-check:
    name: ğŸ“Š VerificaÃ§Ã£o de Estoque
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5 horas max

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        pip install --upgrade pip
        pip cache purge
        pip install -r requirements.txt --verbose

    - name: ğŸ” Configurar credenciais Google
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      run: |
        echo "$GOOGLE_CREDENTIALS" > /tmp/google-credentials.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/google-credentials.json

    - name: ğŸ“Š Executar verificaÃ§Ã£o de estoque
      env:
        GOOGLE_APPLICATION_CREDENTIALS: /tmp/google-credentials.json
        SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        MAGENTO_API_KEY: ${{ secrets.MAGENTO_API_KEY }}
        MAGENTO_BASE_URL: ${{ secrets.MAGENTO_BASE_URL }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '50' }}
      run: |
        echo "ğŸš€ Iniciando verificaÃ§Ã£o de estoque..."
        python main.py || { echo "âŒ Script falhou"; cat *.log; exit 1; }

    - name: ğŸ“ Upload logs de execuÃ§Ã£o
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stock-check-logs-${{ github.run_number }}
        path: |
          *.csv
          *.log
        retention-days: 30

    - name: ğŸ“§ Notificar resultado (sucesso)
      if: success()
      run: |
        echo "âœ… VerificaÃ§Ã£o de estoque concluÃ­da com sucesso!"

    - name: ğŸ“§ Notificar resultado (falha)
      if: failure()
      run: |
        echo "âŒ VerificaÃ§Ã£o de estoque falhou!"

  weekly-report:
    name: ğŸ“ˆ RelatÃ³rio Semanal
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1'  # Apenas nas segundas-feiras
    needs: stock-check

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: ğŸ“Š Gerar relatÃ³rio semanal
      run: |
        echo "ğŸ“ˆ Gerando relatÃ³rio semanal..."
        echo "âœ… RelatÃ³rio gerado!"

# ConfiguraÃ§Ã£o de notificaÃ§Ãµes por email (opcional)
# Adicione esta seÃ§Ã£o se quiser receber emails sobre execuÃ§Ãµes
# notify:
#    name: ğŸ“§ NotificaÃ§Ãµes
#    runs-on: ubuntu-latest
#    needs: stock-check
#    if: always()
#    
#    steps:
#    - name: ğŸ“§ Enviar email de notificaÃ§Ã£o
#      if: always()
#      uses: dawidd6/action-send-mail@v3
#      with:
#        server_address: smtp.gmail.com
#        server_port: 587
#        username: ${{ secrets.EMAIL_USERNAME }}
#        password: ${{ secrets.EMAIL_PASSWORD }}
#        subject: |
#          ${{ job.status == 'success' && 'âœ…' || 'âŒ' }} Stock Check - ${{ github.run_number }}
#        body: |
#          Status: ${{ job.status }}
#          Workflow: ${{ github.workflow }}
#          Run: ${{ github.run_number }}
#          Timestamp: ${{ github.event.head_commit.timestamp }}
          
#          ${{ job.status == 'success' && 'VerificaÃ§Ã£o de estoque executada com sucesso!' || 'Falha na verificaÃ§Ã£o de estoque. Verifique os logs.' }}
#        to: seu-email@exemplo.com
#        from: Sistema de Estoque <noreply@exemplo.com>
